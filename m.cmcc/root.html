<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="api-base-url" content="@(api)" />
    <title></title>
    @(style)
    <style>
.viewport.applaunch { background: url(images/launch.png) no-repeat center top; background-size: auto 100%; opacity: 0; -webkit-transition: opacity 1500ms ease 0ms; }
    </style>
    <script>
        function adjustPx() {
            document.documentElement.style.fontSize = window.innerWidth * 100 / 320 + 'px';
        }
        adjustPx();
    </script>
</head>

<body>
    <div class="viewport applaunch js_global_launch"></div>
    <script>
        (function() {
            var launch = document.querySelector('.js_global_launch');
            var launchImage = localStorage.getItem("LAUNCH_IMAGE");
            if (launchImage) {
                launch.style.backgroundImage = 'url(' + launchImage + ')';
            }
            launch.offsetHeight;
            launch.style.opacity = 1;
        })();
    </script>
    <script src="@(debug?'seajs/sea.js':'slan.m.js')?v@(Date.now())"></script> @if(debug){
    <script src="zepto.js"></script>
    <script src="extend/fx.js"></script>
    <script src="extend/touch.js"></script>
    <script src="extend/matchMedia.js"></script>
    <script src="extend/ortchange.js"></script>
    <script src="anim/default.js"></script> }
    <script>
        seajs.config({
            alias: {
                "$": "zepto",
                'animation': 'core/animation',
                'activity': 'core/activity'
            }
        });

        seajs.use(['$', 'util', 'core/app', 'bridge', 'widget/loader', 'widget/offline'], function($, util, App, bridge, Loader, Offline) {
            var matchUA = navigator.userAgent.match(/SLApp ([0-9\.]+)/);
            sl.isDebug = @debug;
            sl.buildVersion = @(Date.now());
            sl.isInApp = util.isInApp = !!matchUA;
            sl.appVersion = matchUA ? matchUA[1] : '1.0.0';

            $(window).on('ortchange', adjustPx);

            function startApp(res) {
                var resourceMapping = res.data;
                var routes = $.extend(@(JSON.stringify(routes)), res.routes || {});
                var combineMapping = @(JSON.stringify(resourceMapping));

                seajs.on('fetch', function(emitData) {

                    var id = emitData.uri.replace(seajs.data.base, '').replace(/\.js(\?.*){0,1}/, '');

                    if (resourceMapping && resourceMapping[id]) {
                        emitData.requestUri = resourceMapping[id];

                    } else if (combineMapping) {
                        console.log('fetch', id);

                        for (var key in combineMapping) {
                            if (combineMapping[key].indexOf(id) != -1) {
                                emitData.requestUri = resourceMapping && resourceMapping[key] ? resourceMapping[key] : seajs.resolve(key);
                                break;
                            }
                        }
                    }
                });
                seajs.on("error", function(errorData) {
                    errorData.pause = true;

                    Offline.getInstance().show(function() {
                        this.hide();
                        seajs.request(errorData.uri, errorData.callback);
                    });
                });

                new App().mapRoute(routes).start(sl.isInApp ? 2000 : 0);
            }

            @if(!debug && !useLocal) {

                function loadResourceMapping() {
                    loader.reload();
                }

                var loader = new Loader({
                    url: bridge.url('/api/settings/resourceMapping'),
                    params: {
                        v: sl.appVersion
                    },
                    timeout: 5000,
                    checkData: false,
                    $el: $('body'),
                    error: function() {
                        Offline.getInstance().show(loadResourceMapping);
                    },
                    success: function(res) {
                        Offline.getInstance().hide();

                        startApp(res);
                    }

                });
                loadResourceMapping();

            } else {
                startApp({});
            }

        });
    </script>
</body>

</html>